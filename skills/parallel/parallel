#!/bin/bash
# Parallel.ai CLI - Web search and content extraction
# Requires PARALLEL_API_KEY environment variable

API_KEY="${PARALLEL_API_KEY:-}"
BASE_URL="https://api.parallel.ai/v1beta"
BETA_HEADER="parallel-beta: search-extract-2025-10-10"

# Validation
if [ -z "$API_KEY" ]; then
  echo "Error: PARALLEL_API_KEY not set" >&2
  echo "Get your key from: https://platform.parallel.ai" >&2
  exit 1
fi

# API helper with error handling
call_api() {
  local endpoint="$1"
  local payload="$2"
  local response http_code body

  response=$(curl -s -w "\n%{http_code}" -X POST \
    -H "Content-Type: application/json" \
    -H "x-api-key: $API_KEY" \
    -H "$BETA_HEADER" \
    -d "$payload" \
    "${BASE_URL}${endpoint}" 2>&1)

  http_code=$(echo "$response" | tail -n1)
  body=$(echo "$response" | sed '$d')

  # Check for curl failure (non-numeric or 0/000 indicates network error)
  if ! [[ "$http_code" =~ ^[0-9]+$ ]] || [ "$http_code" -eq 0 ]; then
    echo "Error: Failed to reach Parallel.ai API" >&2
    echo "Details: $body" >&2
    return 1
  fi

  # Check for HTTP errors
  if [ "$http_code" -ge 400 ]; then
    echo "Error: API returned HTTP $http_code" >&2
    echo "$body" | jq -r '.error.message // .error // .' 2>/dev/null >&2
    return 1
  fi

  echo "$body"
}

# Format search results as markdown
format_search() {
  jq -r '
    if .results then
      (.results // [])[] |
      "## \(.title // "Untitled")\n" +
      "**URL:** \(.url // "N/A")\n" +
      "**Domain:** \(.domain // (.url | split("/")[2] // "unknown"))\n\n" +
      "\(.excerpt // .snippet // "No excerpt available")\n\n---\n"
    elif .error then
      "Error: \(.error.message // .error // "Unknown error")"
    else
      "No results found"
    end
  '
}

# Format extraction results as markdown
format_extract() {
  jq -r '
    if .results then
      (.results // [])[] |
      "## \(.title // "Extracted Content")\n" +
      "**URL:** \(.url // "N/A")\n\n" +
      (if .content then .content else (.excerpt // "No content extracted") end) +
      "\n\n---\n"
    elif .error then
      "Error: \(.error.message // .error // "Unknown error")"
    else
      "No content extracted"
    end
  '
}

case "${1:-help}" in
  search)
    shift
    query=""
    limit=5

    while [[ $# -gt 0 ]]; do
      case "$1" in
        --limit)
          if [ -z "$2" ] || [[ "$2" == --* ]]; then
            echo "Error: --limit requires a numeric value" >&2
            exit 1
          fi
          limit="$2"
          shift 2
          ;;
        *)
          if [ -z "$query" ]; then
            query="$1"
          else
            query="$query $1"
          fi
          shift
          ;;
      esac
    done

    if [ -z "$query" ]; then
      echo "Error: Search query required" >&2
      echo "Usage: parallel search \"your query\" [--limit N]" >&2
      exit 1
    fi

    if ! [[ "$limit" =~ ^[0-9]+$ ]]; then
      echo "Error: --limit must be a positive integer, got '$limit'" >&2
      exit 1
    fi

    payload=$(jq -n \
      --arg q "$query" \
      --argjson limit "$limit" \
      '{
        objective: "Find relevant information about: \($q)",
        search_queries: [$q],
        max_results: $limit,
        excerpts: {
          max_chars_per_result: 500
        }
      }')

    result=$(call_api "/search" "$payload") || exit 1
    echo "$result" | format_search
    ;;

  extract)
    shift
    url=""
    full_content=false

    while [[ $# -gt 0 ]]; do
      case "$1" in
        --full)
          full_content=true
          shift
          ;;
        *)
          url="$1"
          shift
          ;;
      esac
    done

    if [ -z "$url" ]; then
      echo "Error: URL required" >&2
      echo "Usage: parallel extract <url> [--full]" >&2
      exit 1
    fi

    if [[ ! "$url" =~ ^https?:// ]]; then
      echo "Error: URL must start with http:// or https://" >&2
      echo "Got: $url" >&2
      exit 1
    fi

    payload=$(jq -n \
      --arg url "$url" \
      --argjson full "$full_content" \
      '{
        urls: [$url],
        objective: "Extract the main content from this page",
        excerpts: (if $full then false else true end),
        full_content: $full
      }')

    result=$(call_api "/extract" "$payload") || exit 1
    echo "$result" | format_extract
    ;;

  raw)
    shift
    endpoint="${1:-}"
    payload="${2:-{}}"

    if [ -z "$endpoint" ]; then
      echo "Error: Endpoint required" >&2
      echo "Usage: parallel raw <endpoint> [json-payload]" >&2
      exit 1
    fi

    call_api "$endpoint" "$payload"
    ;;

  help|*)
    cat <<EOF
Parallel.ai CLI - Web search and content extraction

Commands:
  search "query"              Web search with AI-optimized results
  search "query" --limit N    Limit results (default: 5)
  extract <url>               Extract content from URL
  extract <url> --full        Include full page content
  raw <endpoint> [json]       Raw API call
  help                        Show this help

Environment:
  PARALLEL_API_KEY            Required - your Parallel.ai API key

Examples:
  parallel search "latest AI developments"
  parallel search "React 19 features" --limit 10
  parallel extract https://example.com/article
  parallel extract https://example.com/doc.pdf --full
  parallel raw /search '{"search_queries":["test"]}'

Get your API key: https://platform.parallel.ai
EOF
    ;;
esac
